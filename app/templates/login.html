{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}
{% block heading %}{{ title }}{% endblock %}

{% block head %}
    {{ super() }}
    <script src="https://unpkg.com/@simplewebauthn/browser@11.0.0/dist/bundle/index.umd.min.js"
        integrity="sha384-MEoU+35r/Mcpi7hzGCSKXkm+Yu7nRyDqV8z+GjTNBhxzV/JrQXe88JTG1ol0+F1e"
        crossorigin="anonymous"></script>
    <script type="text/javascript">
        const { startAuthentication } = SimpleWebAuthnBrowser;

        function showStatus(message) {
            const el = document.getElementById('login-error');
            el.textContent = message;
            el.style.display = 'block';
        }

        async function login() {
            const btn = document.querySelector('button');
            btn.disabled = true;
            btn.innerText = 'Authenticating...';

            try {
                const options = {{ options | safe }};
                const assertion = await startAuthentication({ optionsJSON: options });
                const res = await fetch('/verify-login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assertion)
                });
                if (res.ok) {
                    location.reload();
                    return;
                }
                const data = await res.json().catch(() => ({}));
                if (data.error === 'not_validated') {
                    showStatus('User is not validated. Contact an administrator.');
                } else {
                    showStatus('Authentication failed. Please try again.');
                }
            } catch (err) {
                console.error(err);
                showStatus('Authentication failed. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Login';
            }
        }
    </script>
{% endblock %}

{% block content %}
        <p class="warning" id="login-error" style="display:none;"></p>
        {% if id %}
        <p class="warning">
            User {{ id }} is not an administrator.
        </p>
        {% endif %}
        <p>
            Please authenticate with an administrator account to continue.
        </p>
        <div>
            <button class="main-button" onclick="login()">Login</button>
        </div>
        <div>
            <img class="logo" src="{{ url_for('static', filename='images/gatepass-logo-no-text.svg') }}" alt="GatePass Logo">
        </div>
{% endblock %}
